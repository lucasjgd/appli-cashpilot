{% extends 'base.html.twig' %}

{% block title %}Détail livret
{% endblock %}

{% block body %}

	<main class="content">
		{% for label, messages in app.flashes %}
			<div class="alert alert-{{ label == 'error' ? 'danger' : label }} alert-dismissible fade show m-2" role="alert">
				{% for message in messages %}
					{{ message }}
				{% endfor %}
				<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
			</div>
		{% endfor %}
		<div class="container py-5">
			<a href="{{ path('lesLivrets') }}" class="btn btn-secondary mt-2">Retour aux livrets</a>
			<div class="d-flex flex-row align-items-center justify-content-between ">
				<div>
					<h2>Livret
						{{ livret.nomLivret }}</h2>
				</div>
				<div>
					<div class="container text-center my-4">
						<button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addCategorieModal">Ajouter une catégorie</button>
						<button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addDepenseModal">Ajouter
																																																															                        une dépense</button>
						<a href="analyse.html" class="btn btn-primary">Analyse du livret</a>
					</div>

					<div class="modal fade" id="addCategorieModal" tabindex="-1" aria-labelledby="addCategorieModalLabel" aria-hidden="true">
						<div class="modal-dialog">
							<div class="modal-content">
								<form method="POST" action="{{ path('ajoutCategLivret', {id: livret.id}) }}">
									<div class="modal-header">
										<h5 class="modal-title" id="addCategorieModalLabel">Ajouter une catégorie</h5>
										<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
									</div>
									<div class="modal-body">
										<div class="mb-3">
											<label for="categorie" class="form-label">Catégorie</label>
											<input type="hidden" id="idLivret" name="idLivret" value="{{ livret.id }}">
											<select class="form-select" name="categorie_id" id="categorie" required>
												<option selected disabled>Choisir une catégorie</option>
												{% for categorie in categories %}
													<option value="{{categorie.id}}">{{categorie.libelle}}</option>
												{% endfor %}
											</select>
										</div>
										<div class="mb-3">
											<label for="budget" class="form-label">Budget maximum (€)</label>
											<input type="number" class="form-control" name="budget" id="budget" required>
										</div>
									</div>
									<div class="modal-footer">
										<button type="submit" class="btn btn-primary">Ajouter</button>
										<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
									</div>
								</form>
							</div>
						</div>
					</div>

					<div class="modal fade" id="addDepenseModal" tabindex="-1" aria-labelledby="addDepenseModalLabel" aria-hidden="true">
						<div class="modal-dialog">
							<div class="modal-content">
								<form method="POST" action="ajouter_depense.php">
									<div class="modal-header">
										<h5 class="modal-title" id="addDepenseModalLabel">Ajouter une dépense</h5>
										<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
									</div>
									<div class="modal-body">
										<div class="mb-3">
											<label for="categorie" class="form-label">Catégorie</label>
											<input type="hidden" id="idLivret" name="idLivret" value="{{ livret.id }}">
											<select class="form-select" name="categorie_id" id="categorie" required>
												<option selected disabled>Choisir une catégorie</option>
												{% for categorie in categories %}
													<option value="{{categorie.id}}">{{categorie.libelle}}</option>
												{% endfor %}
											</select>
										</div>
										<div class="mb-3">
											<label for="montant" class="form-label">Montant (€)</label>
											<input type="number" step="0.01" class="form-control" name="montant" id="montant" required>
										</div>
										<div class="mb-3">
											<label for="description" class="form-label">Description</label>
											<input type="text" class="form-control" name="description" id="description" maxlength="100" required>
										</div>
										<div class="form-check mb-3">
											<input class="form-check-input" type="checkbox" value="1" id="recurrente" name="recurrente">
											<label class="form-check-label" for="recurrente">
												Dépense récurrente
											</label>
										</div>

										<div id="recurrenceFields" style="display: none;">
											<div class="mb-3">
												<label for="frequence" class="form-label">Fréquence</label>
												<select class="form-select" name="frequence" id="frequence">
													<option value="" disabled selected>Choisir la fréquence</option>
													<option value="semaine">Hebdomadaire</option>
													<option value="mois">Mensuelle</option>
													<option value="trimestre">Trimestrielle</option>
												</select>
											</div>
											<div class="mb-3">
												<label for="date_debut" class="form-label">Date de début</label>
												<input type="date" class="form-control" name="date_debut" id="date_debut">
											</div>
											<div class="mb-3">
												<label for="date_fin" class="form-label">Date de fin</label>
												<input type="date" class="form-control" name="date_fin" id="date_fin">
											</div>
										</div>
									</div>
									<div class="modal-footer">
										<button type="submit" class="btn btn-success">Ajouter</button>
										<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
									</div>
								</form>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
				<div class="modal-dialog modal-dialog-centered">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title">Confirmation</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
						</div>
						<div class="modal-body">
							Êtes-vous sûr de vouloir supprimer cette dépense ?
						</div>
						<div class="modal-footer">
							<a id="confirmDeleteBtn" href="#" class="btn btn-danger">Supprimer</a>
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
						</div>
					</div>
				</div>
			</div>

			<div class="modal fade" id="confirmDeleteCategorieModal" tabindex="-1" aria-labelledby="confirmDeleteCategorieModalLabel" aria-hidden="true">
				<div class="modal-dialog modal-dialog-centered">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title">Supprimer la catégorie</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
						</div>
						<div class="modal-body">
							Êtes-vous sûr de vouloir supprimer cette catégorie ? Toutes les dépenses associées seront
																																																															                        également supprimées.
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
							<a id="confirmDeleteCategorieBtn" href="#" class="btn btn-danger">Supprimer</a>
						</div>
					</div>
				</div>
			</div>


			<div class="accordion" id="categoriesAccordion">
				{% for avoir in avoirs %}
					{% set categorie = avoir.categorie %}
					<div class="accordion-item">
						<h2 class="accordion-header" id="heading{{ loop.index }}">
							<div class="d-flex justify-content-between align-items-center">
								<button class="accordion-button {% if loop.first %} {% else %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#cat{{ loop.index }}" aria-expanded="{{ loop.first ? 'true' : 'false' }}" aria-controls="cat{{ loop.index }}">
									{{ categorie.libelle }}
									-
									{% set totalDepenses = 0 %}
									{% for depense in categorie.depenses %}
										{% if depense.livret.id == livret.id %}
											{% set totalDepenses = totalDepenses + depense.montant %}
										{% endif %}
									{% endfor %}
									{{ totalDepenses|number_format(2, ',', ' ') }}
									€ /
									{{ avoir.budgetMaxCateg|number_format(2, ',', ' ') }}
									€
								</button>
								<button class="btn btn-sm btn-outline-secondary ms-4 me-2" data-bs-toggle="modal" data-bs-target="#confirmDeleteCategorieModal">
									<i class="fa-solid fa-pencil"></i>
								</button>
								<button class="btn btn-sm btn-outline-danger ms-2 me-2" data-bs-toggle="modal" data-bs-target="#confirmDeleteCategorieModal">
									<i class="fa-solid fa-xmark"></i>
								</button>
							</div>
						</h2>
						<div id="cat{{ loop.index }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}" aria-labelledby="heading{{ loop.index }}" data-bs-parent="#categoriesAccordion">
							<div class="accordion-body">
								<ul class="list-group">
									{% for depense in categorie.depenses %}
										{% if depense.livret.id == livret.id %}
											<li class="list-group-item d-flex justify-content-between align-items-start">
												<div class="w-25">
													<div class="d-flex justify-content-between align-items-center">
														<strong>{{ depense.description }}</strong>
														<span class="badge bg-secondary rounded-pill fs-6">
															{{ depense.montant|number_format(2, ',', ' ') }}
															€
														</span>
													</div>
													<small class="text-muted">Description :
														{{ depense.description }}</small><br>
													<small class="text-muted">Date :
														{{ depense.date|date('Y-m-d') }}</small>
												</div>
												<div>
													<button class="btn btn-sm btn-secondary ms-2 me-2" data-bs-toggle="modal" data-bs-target="#editDepenseModal-{{ depense.id }}">
														<i class="fa-solid fa-pencil"></i>
													</button>
													<button class="btn btn-sm btn-danger ms-3" data-bs-toggle="modal" data-bs-target="#confirmDeleteDepenseModal-{{ depense.id }}">
														<i class="fa-solid fa-xmark"></i>
													</button>
												</div>
											</li>
										{% endif %}
									{% else %}
										<li class="list-group-item">Aucune dépense dans cette catégorie.</li>
									{% endfor %}
								</ul>
							</div>
						</div>
					</div>
				{% else %}
					<p>Aucune catégorie liée à ce livret.</p>
				{% endfor %}
			</div>
		</div>
	</main>

{% endblock %}
