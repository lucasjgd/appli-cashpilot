{% extends 'base.html.twig' %}

{% block title %}Détail livret
{% endblock %}

{% block body %}

	<main class="content">
		{% for label, messages in app.flashes %}
			<div class="alert alert-{{ label == 'error' ? 'danger' : label }} alert-dismissible fade show m-2" role="alert">
				{% for message in messages %}
					{{ message }}
				{% endfor %}
				<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
			</div>
		{% endfor %}
		<div class="container py-5">
			<a href="{{ path('lesLivrets') }}" class="btn btn-secondary mt-2">Retour aux livrets</a>
			<div class="d-flex flex-row align-items-center justify-content-between ">
				<div>
					<h2>Livret
						{{ livret.nomLivret }}</h2>
				</div>
				<div>
					<div class="container text-center my-4">
						<button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addCategorieModal">Ajouter une catégorie</button>
						<button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addDepenseModal">Ajouter une dépense</button>
						<a href="analyse.html" class="btn btn-primary">Analyse du livret</a>
					</div>

					<div class="modal fade" id="addCategorieModal" tabindex="-1" aria-labelledby="addCategorieModalLabel" aria-hidden="true">
						<div class="modal-dialog">
							<div class="modal-content">
								<form method="POST" action="{{ path('ajoutCategLivret', {id: livret.id}) }}">
									<div class="modal-header">
										<h5 class="modal-title" id="addCategorieModalLabel">Ajouter une catégorie</h5>
										<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
									</div>
									<div class="modal-body">
										<div class="mb-3">
											<label for="categorie" class="form-label">Catégorie</label>
											<input type="hidden" id="idLivret" name="idLivret" value="{{ livret.id }}">
											<select class="form-select" name="categorie_id" id="categorie" required>
												<option selected disabled>Choisir une catégorie</option>
												{% for categorie in categories %}
													<option value="{{categorie.id}}">{{categorie.libelle}}</option>
												{% endfor %}
											</select>
										</div>
										<div class="mb-3">
											<label for="budget" class="form-label">Budget maximum (€)</label>
											<input type="number" class="form-control" name="budget" id="budget" required>
										</div>
									</div>
									<div class="modal-footer">
										<button type="submit" class="btn btn-primary">Ajouter</button>
										<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
									</div>
								</form>
							</div>
						</div>
					</div>
					<div class="modal fade" id="addDepenseModal" tabindex="-1" aria-labelledby="addDepenseModalLabel" aria-hidden="true">
						<div class="modal-dialog">
							<div class="modal-content">
								<form method="POST" action="{{ path('ajouterDepense') }}">
									<div class="modal-header">
										<h5 class="modal-title" id="addDepenseModalLabel">Ajouter une dépense</h5>
										<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
									</div>
									<div class="modal-body">
										<div class="mb-3">
											<label for="categorie" class="form-label">Catégorie</label>
											<input type="hidden" id="idLivret" name="idLivret" value="{{ livret.id }}">
											<select class="form-select" name="categorie_id" id="categorie" required>
												<option selected disabled>Choisir une catégorie</option>
												{% for categorie in categoriesDansLivret %}
													<option value="{{categorie.id}}">{{categorie.libelle}}</option>
												{% endfor %}
											</select>
										</div>
										<div class="mb-3">
											<label for="montant" class="form-label">Montant (€)</label>
											<input type="number" step="0.01" class="form-control" name="montant" id="montant" required>
										</div>
										<div class="mb-3">
											<label for="description" class="form-label">Description</label>
											<input type="text" class="form-control" name="description" id="description" maxlength="100" required>
										</div>
										<div class="form-check mb-3">
											<input class="form-check-input" type="checkbox" value="1" id="recurrente" name="recurrente">
											<label class="form-check-label" for="recurrente">
												Dépense récurrente
											</label>
										</div>
									</div>
									<div class="modal-footer">
										<button type="submit" class="btn btn-success">Ajouter</button>
										<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
									</div>
								</form>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="modal fade" id="modifDepenseModal" tabindex="-1" aria-labelledby="modifDepenseModalLabel" aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<form id="formModifDepense" method="POST">
							<div class="modal-header">
								<h5 class="modal-title" id="modifDepenseModalLabel">Modifier la dépense</h5>
								<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
							</div>
							<div class="modal-body">
								<div class="mb-3">
									<label for="modifMontantDepense" class="form-label">Montant</label>
									<input type="number" step="0.01" class="form-control" id="modifMontantDepense" name="montant" required>
								</div>
								<div class="mb-3">
									<label for="modifDescriptionDepense" class="form-label">Description</label>
									<input type="text" class="form-control" id="modifDescriptionDepense" name="description" required>
								</div>
								<div class="mb-3">
									<label for="modifDateDepense" class="form-label">Date</label>
									<input type="date" class="form-control" id="modifDateDepense" name="date" required>
								</div>
								<div class="form-check mb-3">
									<input class="form-check-input" type="checkbox" value="1" id="modifRecurrenteDepense" name="recurrente">
									<label class="form-check-label" for="modifRecurrenteDepense">
										Dépense récurrente ?
									</label>
								</div>
							</div>
							<div class="modal-footer">
								<button type="submit" class="btn btn-primary">Enregistrer</button>
								<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
							</div>
						</form>
					</div>
				</div>
			</div>


			<div class="modal fade" id="modifCategorieModal" tabindex="-1" aria-labelledby="modifCategorieModalLabel" aria-hidden="true">
				<div class="modal-dialog">
					<form method="POST" class="modal-content" id="formModifCategorie">
						<div class="modal-header">
							<h5 class="modal-title" id="modifCategorieModalLabel">Modifier le budget de la catégorie</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
						</div>
						<div class="modal-body">
							<input type="hidden" name="id_livret" id="modifCategorieLivretId">
							<input type="hidden" name="id_categ" id="modifCategorieCategId">
							<div class="mb-3">
								<label for="modifBudgetCategorie" class="form-label">Budget maximum (€)</label>
								<input type="number" class="form-control" id="modifBudgetCategorie" name="modifBudget" required>
							</div>
						</div>
						<div class="modal-footer">
							<button type="submit" class="btn btn-primary">Enregistrer</button>
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
						</div>
					</form>
				</div>
			</div>
			<div class="d-flex justify-content-between align-items-center my-3">
				<a href="{{ path('detailLivret', { id: livret.id, mois: moisPrecedent, annee: anneePrecedente }) }}" class="btn btn-primary">← Mois précédent</a>

				<h5 class="mb-0">
					{% set moisNom = {'01': 'Janvier', '02': 'Février', '03': 'Mars', '04': 'Avril', '05': 'Mai', '06': 'Juin', '07': 'Juillet', '08': 'Août', '09': 'Septembre', '10': 'Octobre', '11': 'Novembre', '12': 'Décembre'} %}
					{{ moisNom[('%02d'|format(mois))] }}
					{{ annee }}
				</h5>

				<a href="{{ path('detailLivret', { id: livret.id, mois: moisSuivant, annee: anneeSuivante }) }}" class="btn btn-primary">Mois suivant →</a>
			</div>


			<div class="accordion" id="categoriesAccordion">
				{% for avoir in avoirs %}
					{% set categorie = avoir.categorie %}
					<div class="accordion-item">
						<h2 class="accordion-header" id="heading{{ loop.index }}">
							<div class="d-flex justify-content-between align-items-center">
								<button class="accordion-button {% if loop.first %} {% else %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#cat{{ loop.index }}" aria-expanded="{{ loop.first ? 'true' : 'false' }}" aria-controls="cat{{ loop.index }}">
									{{ categorie.libelle }}
									-
									{% set totalDepenses = 0 %}
									{% for depense in categorie.depenses %}
										{% if depense.livret.id == livret.id and depense.date >= dateDebut and depense.date < dateFin %}
											{% set totalDepenses = totalDepenses + depense.montant %}
										{% endif %}
									{% endfor %}

									<span class="ms-1
																																																																																								                        {{
																																																																																								                            totalDepenses == avoir.budgetMaxCateg ? 'text-warning' :
																																																																																								                            (totalDepenses < avoir.budgetMaxCateg ? 'text-success' : 'text-danger')
																																																																																								                        }}">
										{{ totalDepenses|number_format(2, ',', ' ') }}
										/
										{{ avoir.budgetMaxCateg|number_format(2, ',', ' ') }}
										€
									</span>
								</button>
								<button class="btn btn-sm btn-outline-secondary ms-4 me-2" data-bs-toggle="modal" data-bs-target="#modifCategorieModal" data-livret="{{ avoir.livret.id }}" data-categ="{{ avoir.categorie.id }}" data-budget="{{ avoir.budgetMaxCateg }}">
									<i class="fa-solid fa-pencil"></i>
								</button>
								{% if avoir.estActif == true %}
									<a id="confirmDeleteCategorieBtn" href="{{ path('desactiverCateg', {livretId: livret.id, categId: categorie.id}) }}" class="btn btn-sm btn-outline-danger me-2">
										<i class="fa-solid fa-xmark"></i>
									</a>
								{% endif %}
							</div>
						</h2>
						<div id="cat{{ loop.index }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}" aria-labelledby="heading{{ loop.index }}" data-bs-parent="#categoriesAccordion">
							<div class="accordion-body">
								<ul class="list-group">
									{% for depense in categorie.depenses %}
										{% if depense.livret.id == livret.id and depense.date >= dateDebut and depense.date < dateFin %}
											<li class="list-group-item d-flex justify-content-between align-items-start">
												<div class="w-25">
													<div class="d-flex justify-content-between align-items-center">
														<strong>{{ depense.description }}</strong>
														<span class="badge bg-secondary rounded-pill fs-6">
															{{ depense.montant|number_format(2, ',', ' ') }}
															€
														</span>
													</div>
													<div class="d-flex flex-column">
														<small class="text-muted">Date :
															{{ depense.date|date('Y-m-d') }}</small>
														<small class="text-muted">Est récurrente :
															{{ depense.estRecurrente ? 'Oui' : 'Non' }}
														</small>
													</div>
												</div>
												<div>
													<button class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#modifDepenseModal" data-id="{{ depense.id }}" data-montant="{{ depense.montant }}" data-description="{{ depense.description }}" data-date="{{ depense.date.format('Y-m-d') }}" data-recurrente="{{ depense.estRecurrente ? '1' : '0' }}">
														<i class="fa-solid fa-pencil"></i>
													</button>
													<a href="{{ path('supprimerDepense', {livretId: livret.id, depenseId: depense.id}) }}" class="btn btn-sm btn-danger ms-3">
														<i class="fa-solid fa-xmark"></i>
													</a>

												</div>
											</li>
										{% endif %}
									{% else %}
										<li class="list-group-item">Aucune dépense dans cette catégorie.</li>
									{% endfor %}
								</ul>
							</div>
						</div>
					</div>
				{% else %}
					<p class = "text-center mt-5">Aucune catégorie liée à cette période.</p>
				{% endfor %}
			</div>
		</div>
	</main>

{% endblock %}
